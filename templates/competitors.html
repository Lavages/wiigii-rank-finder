<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Competitors Compass</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.cubing.net/v0/css/@cubing/icons/css">
  <style>
    .event-icon {
      font-size: 2.4rem;
      vertical-align: middle;
    }

    /* Result-specific icon sizing */
    .result-icon {
      font-size: 1.8rem;
    }

    /* Custom scrollbar for better appearance */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #5b21b6;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background-color: #1f2937;
    }
  </style>
</head>

<body
  class="min-h-screen bg-gradient-to-br from-gray-900 to-black text-gray-100 p-2 sm:p-4 flex flex-col items-center font-[Inter]">

  <nav
    class="w-full max-w-5xl mx-auto bg-gray-950 bg-opacity-80 rounded-t-2xl sm:rounded-t-3xl shadow-lg border border-purple-800 border-b-0 p-3 sm:p-4 flex flex-wrap justify-center items-center gap-x-2 gap-y-2 sm:gap-x-6 sticky top-0 z-50 backdrop-blur-md">
    <a href="/"
      class="text-xs sm:text-base text-gray-300 hover:text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Rank
      Finder</a>
    <a href="/competitors"
      class="text-xs sm:text-base text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Competitors</a>
    <a href="/specialist"
      class="text-xs sm:text-base text-gray-300 hover:text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Specialist</a>
    <a href="/completionist"
      class="text-xs sm:text-base text-gray-300 hover:text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Completionist</a>
    <a href="/comparison"
      class="text-xs sm:text-base text-gray-300 hover:text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Comparison</a>
    <a href="/competitions"
      class="text-xs sm:text-base text-gray-300 hover:text-purple-400 transition-colors duration-200 font-semibold px-2 sm:px-3">Competitions</a>
  </nav>

  <main
    class="max-w-5xl w-full mx-auto bg-gray-950 bg-opacity-70 rounded-b-2xl sm:rounded-b-3xl shadow-xl p-4 sm:p-8 space-y-6 sm:space-y-10 backdrop-blur-md border border-purple-800 border-t-0 flex-grow">

    <h1
      class="text-3xl sm:text-5xl font-extrabold text-center text-purple-400 drop-shadow-md mb-4 sm:mb-8 leading-tight">
      Competitors Compass ðŸ§­
    </h1>

    <div id="event-selector" class="flex flex-wrap justify-center gap-2 sm:gap-3"></div>

    <div class="flex justify-center mt-6">
      <button id="find-btn"
        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-10 rounded-full shadow-md transition transform active:scale-95">
        Find Competitors
      </button>
    </div>

    <div id="loading-spinner" class="hidden flex justify-center items-center py-6 sm:py-10">
      <svg class="animate-spin h-10 w-10 sm:h-12 sm:w-12 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"></path>
      </svg>
    </div>

    <div id="results-container"
      class="overflow-x-auto custom-scrollbar rounded-xl border border-gray-700 shadow-xl min-h-[200px] flex flex-col items-center justify-center text-sm sm:text-base bg-gray-900 bg-opacity-30">
      <p id="error-message" class="text-red-400 hidden p-4"></p>
      <p id="no-data-message" class="text-gray-500 hidden text-center p-4">No competitors found for this selection.</p>
    </div>
  </main>

  <footer class="w-full max-w-5xl mx-auto text-center text-gray-500 text-xs sm:text-sm mt-6 sm:mt-8 pb-4">
    <p>Â© 2026 Wiigii's WCA Rankings. All rights reserved.</p>
  </footer>

  <script>
    const API_BASE_URL = '/api';

    const EVENT_ICONS = {
      // Official/Selectable Events
      "333": '<span class="cubing-icon event-333 event-icon"></span>',
      "222": '<span class="cubing-icon event-222 event-icon"></span>',
      "444": '<span class="cubing-icon event-444 event-icon"></span>',
      "555": '<span class="cubing-icon event-555 event-icon"></span>',
      "666": '<span class="cubing-icon event-666 event-icon"></span>',
      "777": '<span class="cubing-icon event-777 event-icon"></span>',
      "333oh": '<span class="cubing-icon event-333oh event-icon"></span>',
      "333bf": '<span class="cubing-icon event-333bf event-icon"></span>',
      "333fm": '<span class="cubing-icon event-333fm event-icon"></span>',
      "clock": '<span class="cubing-icon event-clock event-icon"></span>',
      "minx": '<span class="cubing-icon event-minx event-icon"></span>',
      "pyram": '<span class="cubing-icon event-pyram event-icon"></span>',
      "skewb": '<span class="cubing-icon event-skewb event-icon"></span>',
      "sq1": '<span class="cubing-icon event-sq1 event-icon"></span>',
      "444bf": '<span class="cubing-icon event-444bf event-icon"></span>',
      "555bf": '<span class="cubing-icon event-555bf event-icon"></span>',
      "333mbf": '<span class="cubing-icon event-333mbf event-icon"></span>',
      // Display-only / Removed Events
      "333ft": '<span class="cubing-icon event-333ft event-icon></span>',
      "magic": '<span class="cubing-icon event-magic event-icon></span>',
      "mmagic": '<span class="cubing-icon event-mmagic event-icon></span>',
      "333mbo": '<span class="cubing-icon event-333mbo event-icon></span>'
    };

    // List of events that should not have selection buttons
    const HIDDEN_FROM_SELECTOR = ["333ft", "magic", "mmagic", "333mbo", "fto"];

    let selectedEvents = [];

    const eventSelector = document.getElementById("event-selector");
    Object.entries(EVENT_ICONS).forEach(([id, icon]) => {
      // Only create buttons for events NOT in the hidden list
      if (HIDDEN_FROM_SELECTOR.includes(id)) return;

      const btn = document.createElement("button");
      btn.className = "event-btn bg-gray-800 hover:bg-purple-700 text-gray-100 rounded-lg px-3 py-2 shadow transition border border-gray-700";
      btn.innerHTML = icon;
      btn.dataset.event = id;
      btn.addEventListener("click", () => {
        btn.classList.toggle("ring-2");
        btn.classList.toggle("ring-purple-400");
        btn.classList.toggle("bg-purple-900");
        if (selectedEvents.includes(id)) selectedEvents = selectedEvents.filter(e => e !== id);
        else selectedEvents.push(id);
      });
      eventSelector.appendChild(btn);
    });

    function getDisplayIcon(eventId) {
      const rawIcon = EVENT_ICONS[eventId] || eventId;
      // Shrink icon for result display
      if (typeof rawIcon === 'string' && rawIcon.includes('event-icon')) {
        return rawIcon.replace('event-icon', 'event-icon result-icon');
      }
      return rawIcon;
    }

    document.getElementById("find-btn").addEventListener("click", async () => {
      const container = document.getElementById("results-container");
      const spinner = document.getElementById("loading-spinner");
      const errorMsg = document.getElementById("error-message");
      const noData = document.getElementById("no-data-message");

      if (selectedEvents.length === 0) return;

      spinner.classList.remove("hidden");
      errorMsg.classList.add("hidden");
      noData.classList.add("hidden");
      container.querySelectorAll(".specialist-row, .specialist-card").forEach(el => el.remove());

      try {
        const res = await fetch(`${API_BASE_URL}/competitors?events=${selectedEvents.join(",")}`);
        if (!res.ok) throw new Error("Failed to fetch competitors");
        const competitors = await res.json();

        if (!competitors.length) {
          noData.classList.remove("hidden");
          return;
        }

        const tableHtml = `
          <div class="hidden sm:block w-full specialist-row">
            <table class="w-full text-left text-gray-300">
              <thead class="bg-gray-800 text-gray-100 uppercase text-xs sm:text-sm tracking-wider">
                <tr>
                  <th class="px-6 py-4">Name</th>
                  <th class="px-6 py-4">WCA ID</th>
                  <th class="px-6 py-4">Country</th>
                  <th class="px-6 py-4">Completed Events</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-800">
                ${competitors.map(c => `
                  <tr class="bg-gray-950 bg-opacity-40 hover:bg-gray-700 transition-colors duration-200">
                    <td class="px-6 py-4 font-medium text-gray-50">${c.personName}</td>
                    <td class="px-6 py-4">
                      <a href="https://www.worldcubeassociation.org/persons/${c.personId}" target="_blank" class="text-purple-400 hover:text-purple-300 hover:underline break-all">${c.personId}</a>
                    </td>
                    <td class="px-6 py-4">${c.personCountryId}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                            ${c.completed_events.map(e => getDisplayIcon(e)).join(" ")}
                        </div>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>`;

        const cardsHtml = `
          <div class="sm:hidden flex flex-col gap-3 w-full p-4 specialist-card">
            ${competitors.map(c => `
              <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 shadow-md">
                <p class="text-lg font-semibold text-gray-50">${c.personName}</p>
                <p><a href="https://www.worldcubeassociation.org/persons/${c.personId}" target="_blank" class="text-purple-400 hover:text-purple-300 hover:underline break-all">${c.personId}</a></p>
                <p class="mt-1 text-sm text-gray-400">Country: <span class="font-medium">${c.personCountryId}</span></p>
                <div class="mt-2 flex flex-wrap gap-1">${c.completed_events.map(e => getDisplayIcon(e)).join("")}</div>
              </div>
            `).join("")}
          </div>`;

        container.insertAdjacentHTML("beforeend", tableHtml + cardsHtml);
      } catch (err) {
        errorMsg.textContent = err.message;
        errorMsg.classList.remove("hidden");
      } finally {
        spinner.classList.add("hidden");
      }
    });
  </script>

</body>

</html>